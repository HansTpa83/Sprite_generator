#!/usr/bin/env php
<?php

function my_scandir ($dir_path) {
    $arr = [
        'Img' => [],
        'Dir' => []
    ];
//Cherche img dans le dir_path
    foreach (glob($dir_path."/*") as $value){
        if (is_dir($value)){
            array_push($arr['Dir'], $value);
        } else if (str_ends_with($value, ".png")){
            array_push($arr['Img'], $value);
        }
    }
    $i = 0;
//Cherche img dans les sous-dossiers si option -r || --recursive
    if (array_search("-r", $_SERVER['argv']) || array_search("--recursive", $_SERVER['argv'])) {
        while($i < count($arr['Dir'])){
            foreach (glob($arr['Dir'][$i]."/*") as $value){
                if (is_dir($value)){
                    array_push($arr['Dir'], $value);
                } else if (str_ends_with($value, ".png")){
                    array_push($arr['Img'], $value);
                }
            }
            $i++;
        }
    }
    return $arr['Img'];
}
$arrImg = my_scandir($argv[count($argv)-1]);
function my_merge_image ($arrImg) {
    $optionO = false;
    $optionP = false;
    $optionI = false;
    $optionC = false;
    $width = 0;
    $height = 0;
// Check options 
    foreach ($_SERVER['argv'] as $value){
        if (str_contains($value, "-o=") || str_contains($value, "--override-size=")){
            $optionO = explode("=", $value);
            $optionO = $optionO[1];
        } else if (str_contains($value, "-p=") || str_contains($value, "--padding=")){
            $optionP = explode("=", $value);
            $optionP = $optionP[1];
        } else if (str_contains($value, "-i=") || str_contains($value, "--output-image=")){
            $optionI = explode("=", $value);
            $optionI = $optionI[1];  
        }
    }
// Definit taille imgContainer
    $i = 0;
    if ($optionP != false && $optionO == false){
        $height = $optionP*3;
    } else {
        $height = 0;
    }
    while ($i < count($arrImg)){
        if ($optionO != false && $optionP != false){
            $width = $optionO + $optionP * 2;
            $height += $optionO+ $optionP * 2;
        } else if ($optionP != false) {
            if ($width < getimagesize($arrImg[$i])[0] + $optionP * 2){
                $width = getimagesize($arrImg[$i])[0] + $optionP * 2;
            }
            $height += getimagesize($arrImg[$i])[1] + $optionP * 2;
        } else if ($optionO != false) {
            $width = $optionO;
            $height += $optionO;
        } else {
            if ($width < getimagesize($arrImg[$i])[0]){
                $width = getimagesize($arrImg[$i])[0];
            }
            $height += getimagesize($arrImg[$i])[1];
        }
        $i++;
    }
// Crea imgContainer
    $imgContainer = imagecreatetruecolor($width, $height);
// suppr bg color 
    $color = imagecolorallocate($imgContainer, 0, 0, 0);
    imagefill($imgContainer, 0, 0, $color);
    imagecolortransparent($imgContainer, $color);
// Crea img + add imgContainer
    $i = 0;
    if ($optionP != false){
        $height = $optionP;
    } else {
        $height = 0;
    }
    while ($i < count($arrImg)){
        $imgM = imagecreatefrompng($arrImg[$i]);
        if ($optionO != false && $optionP != false){
            $imgM = imagescale($imgM, $optionO);
            imagecopy($imgContainer, $imgM, $optionP, $height, 0, 0, $width, $width);
            $height += $width;
        } else if ($optionO != false) {
            $imgM = imagescale($imgM, $optionO);
            imagecopy($imgContainer, $imgM, 0, $height, 0, 0, $optionO, $optionO);
            $height += $optionO;
        } else if ($optionP != false){
            imagecopy($imgContainer, $imgM, $optionP, $height, 0, 0, getimagesize($arrImg[$i])[0]+$optionP*2, getimagesize($arrImg[$i])[1]+$optionP*2);
            $height += $width+$optionP;
        } else {
            imagecopy($imgContainer, $imgM, 0, $height, 0, 0, getimagesize($arrImg[$i])[0], getimagesize($arrImg[$i])[1]);
            $height += getimagesize($arrImg[$i])[1];
        }     
        $i++;
    }
// choix nom du sprite
    if ($optionI != false) {
        imagepng($imgContainer, $optionI.".png");
    } else {
        imagepng($imgContainer, "sprite.png");
    } 
}
my_merge_image($arrImg);
function my_generate_css($arrImg){
    $optionS = false;
    $optionO = false;
    $optionP = false;
    foreach ($_SERVER['argv'] as $value){
        if (str_contains($value, "-o=") || str_contains($value, "--override-size=")){
            $optionO = explode("=", $value);
            $optionO = $optionO[1];
        } else if (str_contains($value, "-p=") || str_contains($value, "--padding=")){
            $optionP = explode("=", $value);
            $optionP = $optionP[1];
        } else if (str_contains($value, "-s=") || str_contains($value, "--output-style=")){
            $optionS = explode("=", $value);
            $optionS = $optionS[1];  
        }
    }
// Definit nom fichier .css
    if ($optionS != false) {
        $css = fopen($optionS.".css", "w");
    } else {
        $css = fopen("style.css", "w");
    }
// 1ere ligne 
    $str = ".sprite {\n\tbackground-image: url(spritesheet.png);\n\tbackground-repeat: no-repeat;\n\tdisplay: block;\n}\n";
    fwrite($css, $str);
    $i = 0;
    $height = 0;
    while ($i < count($arrImg)){
        $name = explode("/", $arrImg[$i]);
        $name = $name[count($name)-1];
        $name = substr($name, 0, -4); 

        if ($optionO != false && $optionP != false) {
            $str = ".sprite-".$name."{\n\twidth: ".$optionO."px;\n\theight: ".$optionO."px;\n\tbackground-position:".$optionP."px ".$height."px;\n}\n";
            fwrite($css, $str);
            $height += $optionO;
        }else if ($optionO != false) {
            $str = ".sprite-".$name."{\n\twidth: ".$optionO."px;\n\theight: ".$optionO."px;\n\tbackground-position: 0px ".$height."px;\n}\n";
            fwrite($css, $str);
            $height += $optionO;
        } else if ($optionP != false){
            $str = ".sprite-".$name."{\n\twidth: ".getimagesize($arrImg[$i])[0]."px;\n\theight: ".getimagesize($arrImg[$i])[1]."px;\n\tbackground-position:".$optionP."px ".$height."px;\n}\n";
            fwrite($css, $str);
            $height += getimagesize($arrImg[$i])[1];
        } else {
            $str = ".sprite-".$name."{\n\twidth: ".getimagesize($arrImg[$i])[0]."px;\n\theight: ".getimagesize($arrImg[$i])[1]."px;\n\tbackground-position: 0px ".$height."px;\n}\n";
            fwrite($css, $str);
            $height += getimagesize($arrImg[$i])[1];
        }
        $i++;
    }
}
my_generate_css($arrImg);